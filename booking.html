<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>USIU-A Transport ‚Äî Booking Dashboard</title>

  <!-- Tailwind CDN for quick styling (demo) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --usiublue:#00274D;
      --usiugold:#FDB813;
      --empty-blue:#3B82F6;
      --booked-yellow:#FBBF24;
      --confirmed-green:#10B981;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .seat{min-width:44px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;user-select:none;margin:4px}
    .seat.empty{background:var(--empty-blue);color:#fff}
    .seat.booked{background:var(--booked-yellow);color:#073642;cursor:not-allowed}
    .seat.confirmed{background:var(--confirmed-green);color:#073642;cursor:not-allowed}
    .seat.selected{outline:3px solid rgba(0,0,0,0.12);transform:scale(1.03)}
    .aisle{width:28px}
    @media (max-width:900px){ .seat{min-width:36px;height:32px;margin:3px}.aisle{width:18px} }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Top bar -->
  <div class="bg-white shadow-sm sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <button id="backHome" class="px-3 py-1 rounded bg-usiugold text-usiublue" title="Back to Login">‚Üê Logout</button>
        <div class="text-lg font-semibold" style="color:var(--usiublue)">USIU-A Transport ‚Äî Booking Dashboard</div>
      </div>

      <div class="flex items-center gap-3 text-sm">
        <div id="userInfo" class="text-gray-700"></div>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left column: filters -->
    <aside class="col-span-1 bg-white rounded-lg p-5 shadow-sm">
      <h3 class="text-lg font-semibold text-usiublue">Booking Filters</h3>

      <!-- Travel Date -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Travel Date</label>
        <input 
          id="travelDate" 
          type="date" 
          class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"
        />
      </div>

      <!-- Direction -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Direction</label>
        <select id="direction" class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue">
          <option value="to">To School</option>
          <option value="from">From School</option>
          <option value="custom">Custom Pickup/Drop-off</option>
        </select>
      </div>

      <!-- Custom Pickup/Drop-off Location -->
      <div id="customDirectionContainer" class="mt-2 hidden">
        <input 
          id="customDirection" 
          type="text" 
          placeholder="Enter pickup or drop-off location"
          class="w-full border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"
        />
      </div>

      <!-- Time Selection -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Travel Time</label>
        <select id="timeType" class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue">
          <option value="preset">Preset Times</option>
          <option value="custom">Custom Time</option>
        </select>
      </div>

      <!-- Preset Time Options -->
      <div id="presetTimeContainer" class="mt-2">
        <select id="timeSelect" class="w-full border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"></select>
      </div>

      <!-- Custom Time Input -->
      <div id="customTimeContainer" class="mt-2 hidden">
        <input 
          id="customTime" 
          type="time" 
          class="w-full border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"
        />
      </div>

      <!-- Route Selection -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Route/Location</label>
        <select id="routeType" class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue">
          <option value="preset">Preset Routes</option>
          <option value="custom">Custom Location</option>
        </select>
      </div>

      <!-- Preset Route Options -->
      <div id="presetRouteContainer" class="mt-2">
        <select id="routeSelect" class="w-full border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"></select>
      </div>

      <!-- Custom Route Input -->
      <div id="customRouteContainer" class="mt-2 hidden">
        <input 
          id="customRoute" 
          type="text" 
          placeholder="Enter pickup/drop-off location"
          class="w-full border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"
        />
      </div>

      <!-- Bus Selection -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Choose Bus</label>
        <select id="busSelect" class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue"></select>
      </div>

      <!-- Trip Type Selection -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Trip Type</label>
        <select id="tripType" class="w-full mt-1 border border-gray-300 px-3 py-2 rounded focus:outline-none focus:ring-2 focus:ring-usiublue">
          <option value="individual">Individual Person</option>
          <option value="class">Class Trip</option>
          <option value="school">School Trip</option>
          <option value="group">Group Booking</option>
        </select>
        <p class="text-xs text-gray-500 mt-1">
          üí° Class/School/Group bookings allow multiple seat selection
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="mt-4 flex gap-2">
        <button id="refreshBtn" class="flex-1 border border-gray-300 px-3 py-2 rounded hover:bg-gray-50">Refresh</button>
        <button id="clearBusBtn" class="flex-1 border border-gray-300 px-3 py-2 rounded hover:bg-gray-50">Clear Bus</button>
      </div>

      <!-- Legend -->
      <div class="mt-4 text-xs text-gray-600">
        <p class="font-medium mb-2">Seat Legend:</p>
        <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 bg-blue-500 rounded"></span> Available</div>
        <div class="flex items-center gap-2 mt-1"><span class="inline-block w-3 h-3 bg-yellow-400 rounded"></span> Booked (Pending)</div>
        <div class="flex items-center gap-2 mt-1"><span class="inline-block w-3 h-3 bg-green-500 rounded"></span> Confirmed</div>
      </div>

      <!-- Export Button -->
      <div class="mt-4">
        <button id="exportBtn" class="w-full border border-gray-300 px-3 py-2 rounded hover:bg-gray-50">Export CSV (this bus)</button>
      </div>
    </aside>

    <!-- Right column: seat map + actions (span 2) -->
    <main class="col-span-1 lg:col-span-2 bg-white rounded-lg p-6 shadow-sm">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 id="busTitle" class="text-2xl font-semibold text-usiublue">Select a bus</h2>
          <div id="busMeta" class="text-sm text-gray-600">Choose date, route, time, and bus from the filters</div>
        </div>

        <div class="flex gap-2 items-center">
          <div class="text-sm text-gray-600">
            <span id="seatLabel">Selected:</span> 
            <span id="selectedSeat" class="font-semibold">none</span>
          </div>
          <button id="bookBtn" class="px-4 py-2 bg-usiugold text-usiublue rounded font-medium hover:bg-yellow-500">Book Seat(s)</button>
          <button id="unbookBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded hidden hover:bg-gray-200">Unbook My Seat</button>
        </div>
      </div>

      <div id="seatArea" class="bg-gray-50 p-4 rounded min-h-[300px]">
        <div id="seatMap">Select a bus from the left to view seat map</div>
      </div>

      <div id="bookedList" class="mt-4 text-sm text-gray-700"></div>
    </main>
  </div>

<script>
/* ---------- Configuration ---------- */
const ROUTES = ["Karen", "Langata", "Pangani", "Parkland", "Juja", "CBD"];
const PRESET_TIMES = { 
  to: ["6:00 AM", "7:00 AM", "8:00 AM", "10:00 AM", "1:00 PM"], 
  from: ["2:00 PM", "4:00 PM", "6:00 PM", "8:00 PM"],
  custom: ["6:00 AM", "7:00 AM", "8:00 AM", "10:00 AM", "1:00 PM", "2:00 PM", "4:00 PM", "6:00 PM", "8:00 PM"]
};
const BUSES = [
  { id:1, name:"Bus 1", capacity:56, leftPerRow:3, rightPerRow:2, rowsFull:10, backExtra:6 },
  { id:2, name:"Bus 2", capacity:56, leftPerRow:3, rightPerRow:2, rowsFull:10, backExtra:6 },
  { id:3, name:"Bus 3", capacity:33, leftPerRow:2, rightPerRow:2, rowsFull:8, backExtra:1 },
  { id:4, name:"Bus 4", capacity:33, leftPerRow:2, rightPerRow:2, rowsFull:8, backExtra:1 },
  { id:5, name:"Bus 5", capacity:33, leftPerRow:2, rightPerRow:2, rowsFull:8, backExtra:1 },
  { id:6, name:"Bus 6", capacity:33, leftPerRow:2, rightPerRow:2, rowsFull:8, backExtra:1 },
  { id:7, name:"Bus 7", capacity:33, leftPerRow:2, rightPerRow:2, rowsFull:8, backExtra:1 }
];
const STORAGE_KEY = "usiu_bookings";

/* ---------- State ---------- */
let state = { 
  loggedInStudent: null, 
  selectedBusId: null, 
  selectedSeat: null,
  selectedSeats: [] // For multiple seat selection
};

/* ---------- Check if multiple seat selection is enabled ---------- */
function isMultiSeatMode() {
  const tripType = $('tripType').value;
  return tripType !== 'individual';
}

/* ---------- Update selected seats display ---------- */
function updateSelectedSeatsDisplay() {
  if (isMultiSeatMode()) {
    $('seatLabel').textContent = `Selected (${state.selectedSeats.length}):`;
    $('selectedSeat').textContent = state.selectedSeats.length > 0 ? state.selectedSeats.join(', ') : 'none';
  } else {
    $('seatLabel').textContent = 'Selected:';
    $('selectedSeat').textContent = state.selectedSeat || 'none';
  }
}

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
function loadBookings(){ 
  try{ 
    return JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}"); 
  } catch(e){ 
    return {}; 
  } 
}
function saveBookings(obj){ 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); 
}

/* ---------- Check login on page load ---------- */
function checkLogin() {
  const session = localStorage.getItem("currentUser");
  if (!session) {
    alert("Please log in first");
    window.location.href = "login.html";
    return false;
  }
  
  try {
    const user = JSON.parse(session);
    if (user.role !== "student") {
      alert("This page is for students only");
      window.location.href = "login.html";
      return false;
    }
    
    state.loggedInStudent = {
      studentId: user.id,
      email: user.email || `${user.id}@usiu.ac.ke`
    };
    
    $('userInfo').textContent = `Student: ${user.id}`;
    return true;
  } catch(e) {
    alert("Invalid session. Please log in again.");
    window.location.href = "login.html";
    return false;
  }
}

/* ---------- Logout ---------- */
$('backHome').addEventListener('click', () => {
  localStorage.removeItem("currentUser");
  window.location.href = "login.html";
});

/* ---------- Initialize UI ---------- */
function initializeUI() {
  // Set today's date as default
  const today = new Date();
  const dateStr = today.toISOString().split('T')[0];
  $('travelDate').value = dateStr;
  $('travelDate').min = dateStr; // Prevent booking past dates

  // Populate routes
  ROUTES.forEach(route => {
    const option = document.createElement('option');
    option.value = route;
    option.textContent = route;
    $('routeSelect').appendChild(option);
  });

  // Populate buses
  BUSES.forEach(bus => {
    const option = document.createElement('option');
    option.value = bus.id;
    option.textContent = `${bus.name} (${bus.capacity} seats)`;
    $('busSelect').appendChild(option);
  });

  // Populate initial times
  updateTimes();
}

/* ---------- Time Type Toggle ---------- */
$('timeType').addEventListener('change', () => {
  const timeType = $('timeType').value;
  if (timeType === 'custom') {
    $('presetTimeContainer').classList.add('hidden');
    $('customTimeContainer').classList.remove('hidden');
  } else {
    $('presetTimeContainer').classList.remove('hidden');
    $('customTimeContainer').classList.add('hidden');
  }
});

/* ---------- Route Type Toggle ---------- */
$('routeType').addEventListener('change', () => {
  const routeType = $('routeType').value;
  if (routeType === 'custom') {
    $('presetRouteContainer').classList.add('hidden');
    $('customRouteContainer').classList.remove('hidden');
  } else {
    $('presetRouteContainer').classList.remove('hidden');
    $('customRouteContainer').classList.add('hidden');
  }
});

/* ---------- Update Times based on Direction ---------- */
function updateTimes() {
  const direction = $('direction').value;
  const timeSelect = $('timeSelect');
  timeSelect.innerHTML = '';
  
  const times = PRESET_TIMES[direction] || [];
  times.forEach(time => {
    const option = document.createElement('option');
    option.value = time;
    option.textContent = time;
    timeSelect.appendChild(option);
  });
}

$('direction').addEventListener('change', () => {
  updateTimes();
  
  // Show/hide custom direction input
  const direction = $('direction').value;
  if (direction === 'custom') {
    $('customDirectionContainer').classList.remove('hidden');
  } else {
    $('customDirectionContainer').classList.add('hidden');
  }
  
  if (state.selectedBusId) {
    renderSeatMap(state.selectedBusId);
  }
});

/* ---------- Get current selections ---------- */
function getCurrentDirection() {
  const direction = $('direction').value;
  if (direction === 'custom') {
    const customDir = $('customDirection').value.trim();
    return customDir || 'Custom Location';
  }
  return direction === 'to' ? 'To School' : 'From School';
}

function getCurrentRoute() {
  const routeType = $('routeType').value;
  if (routeType === 'custom') {
    const customRoute = $('customRoute').value.trim();
    return customRoute || 'Custom Location';
  }
  return $('routeSelect').value;
}

function getCurrentTime() {
  const timeType = $('timeType').value;
  if (timeType === 'custom') {
    return $('customTime').value || '00:00';
  }
  return $('timeSelect').value;
}

/* ---------- Make Bus Key ---------- */
function makeBusKey() {
  const route = getCurrentRoute();
  const busId = state.selectedBusId;
  const direction = $('direction').value;
  const date = $('travelDate').value;
  const time = getCurrentTime();
  
  if (!route || !busId || !time || !date) return null;
  
  return `${route}__bus${busId}__${direction}__${time}__${date}`;
}

/* ---------- Render Seat Map ---------- */
function renderSeatMap(busId) {
  state.selectedBusId = busId;
  state.selectedSeat = null;
  state.selectedSeats = [];
  updateSelectedSeatsDisplay();

  const bus = BUSES.find(b => b.id === busId);
  if (!bus) return;

  const key = makeBusKey();
  const allBookings = loadBookings();
  const bookingsForThisBus = (key && allBookings[key]) ? allBookings[key] : [];

  // Update bus title
  $('busTitle').textContent = bus.name;
  $('busMeta').textContent = `Capacity: ${bus.capacity} seats | Route: ${getCurrentRoute()} | Date: ${$('travelDate').value}`;

  // Create seat map container
  const seatMap = document.createElement('div');
  seatMap.style.display = 'flex';
  seatMap.style.flexDirection = 'column';
  seatMap.style.gap = '8px';

  // Helper to create seat element
  function mkSeat(label) {
    const seat = document.createElement('div');
    seat.className = 'seat empty';
    seat.textContent = label;

    // Check if seat is booked
    const booking = bookingsForThisBus.find(b => b.seat === label);
    if (booking) {
      seat.className = booking.confirmed ? 'seat confirmed' : 'seat booked';
      seat.title = `Booked by ${booking.studentId}`;
    } else {
      // Allow selection only for empty seats
      seat.onclick = () => {
        if (isMultiSeatMode()) {
          // Multiple seat selection mode
          const index = state.selectedSeats.indexOf(label);
          if (index > -1) {
            // Deselect seat
            state.selectedSeats.splice(index, 1);
            seat.classList.remove('selected');
          } else {
            // Select seat
            state.selectedSeats.push(label);
            seat.classList.add('selected');
          }
          updateSelectedSeatsDisplay();
        } else {
          // Single seat selection mode
          document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
          seat.classList.add('selected');
          state.selectedSeat = label;
          state.selectedSeats = [label];
          updateSelectedSeatsDisplay();
        }
      };
    }

    return seat;
  }

  // Render full rows
  for (let row = 1; row <= bus.rowsFull; row++) {
    const rowWrap = document.createElement('div');
    rowWrap.style.display = 'flex';
    rowWrap.style.alignItems = 'center';

    // Left side seats
    const leftWrap = document.createElement('div');
    leftWrap.style.display = 'flex';
    for (let i = 1; i <= bus.leftPerRow; i++) {
      const label = `${rowLetter(row)}${i}`;
      leftWrap.appendChild(mkSeat(label));
    }
    rowWrap.appendChild(leftWrap);

    // Aisle
    const aisle = document.createElement('div');
    aisle.className = 'aisle';
    rowWrap.appendChild(aisle);

    // Right side seats
    const rightWrap = document.createElement('div');
    rightWrap.style.display = 'flex';
    for (let j = 1; j <= bus.rightPerRow; j++) {
      const idx = bus.leftPerRow + j;
      const label = `${rowLetter(row)}${idx}`;
      rightWrap.appendChild(mkSeat(label));
    }
    rowWrap.appendChild(rightWrap);

    seatMap.appendChild(rowWrap);
  }

  // Render back partial row
  if (bus.backExtra && bus.backExtra > 0) {
    const rowsFull = bus.rowsFull;
    const rowDiv = document.createElement('div');
    rowDiv.style.display = 'flex';
    rowDiv.style.alignItems = 'center';

    const leftInPartial = Math.min(bus.leftPerRow, bus.backExtra);
    const rightInPartial = Math.max(0, bus.backExtra - leftInPartial);

    const leftWrap = document.createElement('div');
    leftWrap.style.display = 'flex';
    for (let i = 1; i <= leftInPartial; i++) {
      const label = `${rowLetter(rowsFull + 1)}${i}`;
      leftWrap.appendChild(mkSeat(label));
    }
    rowDiv.appendChild(leftWrap);

    const aisle = document.createElement('div');
    aisle.className = 'aisle';
    rowDiv.appendChild(aisle);

    const rightWrap = document.createElement('div');
    rightWrap.style.display = 'flex';
    const rightStart = leftInPartial + 1;
    for (let j = 0; j < rightInPartial; j++) {
      const idx = rightStart + j;
      const label = `${rowLetter(rowsFull + 1)}${idx}`;
      rightWrap.appendChild(mkSeat(label));
    }
    rowDiv.appendChild(rightWrap);
    seatMap.appendChild(rowDiv);
  }

  $('seatMap').innerHTML = '';
  $('seatMap').appendChild(seatMap);
  renderBookedList();
}

/* Row letter helper */
function rowLetter(n) {
  return String.fromCharCode(64 + n);
}

/* ---------- Booking Actions ---------- */
$('bookBtn').addEventListener('click', () => {
  if (!state.loggedInStudent) {
    alert('Please log in as a student to book.');
    return;
  }

  if (!state.selectedBusId) {
    alert('Please select a bus first.');
    return;
  }

  const seatsToBook = isMultiSeatMode() ? state.selectedSeats : [state.selectedSeat].filter(Boolean);

  if (seatsToBook.length === 0) {
    alert('Please select at least one seat first.');
    return;
  }

  const key = makeBusKey();
  if (!key) {
    alert('Please select date, route, time, and bus first.');
    return;
  }

  // Validate date is not in the past
  const selectedDate = new Date($('travelDate').value);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (selectedDate < today) {
    alert('Cannot book for past dates.');
    return;
  }

  // Check custom direction input if custom is selected
  const direction = $('direction').value;
  if (direction === 'custom' && !$('customDirection').value.trim()) {
    alert('Please enter a pickup or drop-off location for custom direction.');
    return;
  }

  const allBookings = loadBookings();
  if (!allBookings[key]) allBookings[key] = [];

  // Check if any selected seat is already booked
  const alreadyBooked = seatsToBook.filter(seat => 
    allBookings[key].find(b => b.seat === seat)
  );

  if (alreadyBooked.length > 0) {
    alert(`The following seat(s) are already booked: ${alreadyBooked.join(', ')}\n\nPlease deselect them and try again.`);
    return;
  }

  // Get all booking details
  const route = getCurrentRoute();
  const directionText = getCurrentDirection();
  const time = getCurrentTime();
  const date = $('travelDate').value;
  const busName = BUSES.find(b => b.id === state.selectedBusId)?.name || 'Unknown';
  const tripType = $('tripType').value;
  const tripTypeText = {
    'individual': 'Individual Person',
    'class': 'Class Trip',
    'school': 'School Trip',
    'group': 'Group Booking'
  }[tripType];

  // Show confirmation popup
  const seatsList = seatsToBook.join(', ');
  const seatWord = seatsToBook.length > 1 ? 'seats' : 'seat';
  const confirmMessage = `
Please confirm your booking details:

üìÖ Date: ${date}
üïê Time: ${time}
üìç Route: ${route}
üöè Direction: ${directionText}
üöå Bus: ${busName}
üí∫ Seat(s): ${seatsList} (${seatsToBook.length} ${seatWord})
üë• Trip Type: ${tripTypeText}

Click OK to confirm your booking.
  `;

  if (!confirm(confirmMessage)) {
    return;
  }

  // Create bookings for all selected seats
  const newBookings = seatsToBook.map(seat => ({
    studentId: state.loggedInStudent.studentId,
    email: state.loggedInStudent.email,
    route: route,
    direction: $('direction').value,
    directionText: directionText,
    customDirection: direction === 'custom' ? $('customDirection').value.trim() : null,
    time: time,
    date: date,
    seat: seat,
    bus: busName,
    tripType: tripType,
    tripTypeText: tripTypeText,
    confirmed: false,
    timestamp: new Date().toISOString(),
    groupBookingId: isMultiSeatMode() ? `GROUP_${Date.now()}` : null // Link multiple seats together
  }));

  allBookings[key].push(...newBookings);
  saveBookings(allBookings);
  
  alert(`‚úÖ Booking Confirmed!\n\n${seatsToBook.length} ${seatWord} booked successfully: ${seatsList}\n\nYour booking is pending admin approval. You will receive an email notification once approved.`);
  
  // Refresh the seat map
  renderSeatMap(state.selectedBusId);
  state.selectedSeat = null;
  state.selectedSeats = [];
  updateSelectedSeatsDisplay();
});

$('unbookBtn').addEventListener('click', () => {
  if (!state.loggedInStudent) {
    alert('Please log in to unbook.');
    return;
  }

  if (!state.selectedBusId) {
    alert('Please select a bus first.');
    return;
  }

  if (!state.selectedSeat) {
    alert('Please select your booked seat to unbook.');
    return;
  }

  const key = makeBusKey();
  const allBookings = loadBookings();
  const bookingsForThisBus = allBookings[key] || [];

  const bookingIndex = bookingsForThisBus.findIndex(
    b => b.seat === state.selectedSeat && b.studentId === state.loggedInStudent.studentId
  );

  if (bookingIndex === -1) {
    alert('You can only unbook seats that you have booked.');
    return;
  }

  bookingsForThisBus.splice(bookingIndex, 1);
  allBookings[key] = bookingsForThisBus;
  saveBookings(allBookings);

  alert(`Seat ${state.selectedSeat} unbooked successfully.`);
  
  renderSeatMap(state.selectedBusId);
  state.selectedSeat = null;
  $('selectedSeat').textContent = 'none';
});

/* ---------- Render Booked List ---------- */
function renderBookedList() {
  const key = makeBusKey();
  const allBookings = loadBookings();
  const bookingsForThisBus = (key && allBookings[key]) ? allBookings[key] : [];

  if (!bookingsForThisBus || bookingsForThisBus.length === 0) {
    $('bookedList').innerHTML = '<div class="text-sm text-gray-600">No bookings yet for this bus.</div>';
    return;
  }

  const html = ['<strong class="text-usiublue">Current Bookings</strong>'];
  bookingsForThisBus.slice().reverse().forEach(b => {
    const timestamp = new Date(b.timestamp).toLocaleString();
    const status = b.confirmed ? '‚úì Confirmed' : '‚è≥ Pending';
    const statusClass = b.confirmed ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
    
    html.push(`
      <div class="p-3 mt-2 rounded border border-gray-200 bg-gray-50">
        <div class="flex justify-between items-start">
          <div>
            <span class="font-bold text-lg text-usiublue">${b.seat}</span>
            <span class="ml-2 text-xs px-2 py-1 rounded ${statusClass}">${status}</span>
          </div>
          <div class="text-xs text-gray-600">${timestamp}</div>
        </div>
        <div class="text-sm text-gray-700 mt-1">
          ${b.studentId} ‚Ä¢ ${b.email}
        </div>
        <div class="text-xs text-gray-600 mt-1">
          ${b.route} - ${b.time}${b.tripTypeText ? ' ‚Ä¢ ' + b.tripTypeText : ''}
        </div>
      </div>
    `);
  });

  $('bookedList').innerHTML = html.join('');
}

/* ---------- Refresh Button ---------- */
$('refreshBtn').addEventListener('click', () => {
  if (state.selectedBusId) {
    renderSeatMap(state.selectedBusId);
    alert('Seat map refreshed');
  } else {
    alert('Please select a bus first');
  }
});

/* ---------- Clear Bus Button ---------- */
$('clearBusBtn').addEventListener('click', () => {
  state.selectedBusId = null;
  state.selectedSeat = null;
  $('selectedSeat').textContent = 'none';
  $('busTitle').textContent = 'Select a bus';
  $('busMeta').textContent = 'Choose date, route, time, and bus from the filters';
  $('seatMap').innerHTML = 'Select a bus from the left to view seat map';
  $('bookedList').innerHTML = '';
});

/* ---------- Export CSV ---------- */
$('exportBtn').addEventListener('click', () => {
  const key = makeBusKey();
  if (!key) {
    alert('Please select date, route, time, and bus first');
    return;
  }

  const allBookings = loadBookings();
  const bookingsForThisBus = allBookings[key] || [];

  if (!bookingsForThisBus || bookingsForThisBus.length === 0) {
    alert('No bookings to export for this bus');
    return;
  }

  const header = 'Seat,Student ID,Email,Route,Direction,Custom Direction,Time,Date,Bus,Trip Type,Status,Timestamp';
  const lines = bookingsForThisBus.map(b => 
    `${b.seat},${b.studentId},${b.email},${b.route},${b.directionText || b.direction},${b.customDirection || 'N/A'},${b.time},${b.date},${b.bus},${b.tripTypeText || 'N/A'},${b.confirmed ? 'Confirmed' : 'Pending'},${b.timestamp}`
  );

  const csv = [header, ...lines].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `bookings_${key}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ---------- Event Listeners for Filter Changes ---------- */
$('routeSelect')?.addEventListener('change', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('customRoute')?.addEventListener('input', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('customDirection')?.addEventListener('input', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('timeSelect')?.addEventListener('change', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('customTime')?.addEventListener('change', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('travelDate')?.addEventListener('change', () => {
  if (state.selectedBusId) renderSeatMap(state.selectedBusId);
});

$('busSelect')?.addEventListener('change', () => {
  const busId = parseInt($('busSelect').value, 10);
  if (busId) renderSeatMap(busId);
});

$('tripType')?.addEventListener('change', () => {
  // When trip type changes, reset selections and re-render to update selection mode
  if (state.selectedBusId) {
    state.selectedSeat = null;
    state.selectedSeats = [];
    renderSeatMap(state.selectedBusId);
  }
});

/* ---------- Initialize on Page Load ---------- */
window.addEventListener('load', () => {
  // Check if user is logged in
  if (!checkLogin()) return;

  // Initialize UI elements
  initializeUI();

  // Set default bus and render
  if ($('busSelect').options.length > 0) {
    $('busSelect').selectedIndex = 0;
    const firstBusId = parseInt($('busSelect').value, 10);
    if (firstBusId) renderSeatMap(firstBusId);
  }
});
</script>

</body>
</html>