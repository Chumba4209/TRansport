<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | USIU Transport</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
    }

    .header {
      background: linear-gradient(to right, #002855, #ffd100);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 24px;
    }

    .logout-btn {
      background: white;
      color: #002855;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .logout-btn:hover {
      background: #ffd100;
    }

    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card h3 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .stat-card .number {
      font-size: 32px;
      font-weight: bold;
      color: #002855;
    }

    .bookings-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .bookings-section h2 {
      color: #002855;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filters select {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #002855;
      color: white;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-approved {
      background: #d4edda;
      color: #155724;
    }

    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }

    .action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
    }

    .approve-btn {
      background: #28a745;
      color: white;
    }

    .reject-btn {
      background: #dc3545;
      color: white;
    }

    .approve-btn:hover {
      background: #218838;
    }

    .reject-btn:hover {
      background: #c82333;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      width: 90%;
    }

    .modal-content h3 {
      margin-bottom: 15px;
      color: #002855;
    }

    .modal-content textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      min-height: 100px;
      margin-bottom: 15px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }

    .confirm-reject {
      background: #dc3545;
      color: white;
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
    }
  </style>
</head>

<body>

<div class="header">
  <h1>Admin Dashboard</h1>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <!-- Statistics Cards -->
  <div class="stats">
    <div class="stat-card">
      <h3>Total Bookings</h3>
      <div class="number" id="totalBookings">-</div>
    </div>
    <div class="stat-card">
      <h3>Pending</h3>
      <div class="number" id="pendingBookings">-</div>
    </div>
    <div class="stat-card">
      <h3>Approved</h3>
      <div class="number" id="approvedBookings">-</div>
    </div>
    <div class="stat-card">
      <h3>Rejected</h3>
      <div class="number" id="rejectedBookings">-</div>
    </div>
  </div>

  <!-- Bookings Table -->
  <div class="bookings-section">
    <h2>Booking Requests</h2>

    <div class="filters">
      <select id="statusFilter" onchange="loadBookings()">
        <option value="">All Status</option>
        <option value="pending" selected>Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="loadingMessage" class="loading" style="display: none;">Loading bookings...</div>

    <table id="bookingsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Student</th>
          <th>Email</th>
          <th>Date</th>
          <th>Time</th>
          <th>Vehicle</th>
          <th>Seat</th>
          <th>Location</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="bookingsBody">
        <!-- Bookings will be loaded here -->
      </tbody>
    </table>
  </div>
</div>

<!-- Rejection Modal -->
<div id="rejectModal" class="modal">
  <div class="modal-content">
    <h3>Reject Booking</h3>
    <p>Please provide a reason for rejection:</p>
    <textarea id="rejectionReason" placeholder="E.g., Vehicle is fully booked..."></textarea>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeRejectModal()">Cancel</button>
      <button class="confirm-reject" onclick="confirmReject()">Reject Booking</button>
    </div>
  </div>
</div>

<script>
  const API_URL = 'http://localhost:8000/api';
  let currentRejectBookingId = null;

  // Check if user is logged in and is admin
  function checkAuth() {
    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');

    if (!token || user.role !== 'admin') {
      alert('Access denied. Admin login required.');
      window.location.href = 'login.html';
      return false;
    }
    return true;
  }

  // Get auth token
  function getAuthToken() {
    return localStorage.getItem('authToken');
  }

  // Load bookings from API
  async function loadBookings() {
    if (!checkAuth()) return;

    const status = document.getElementById('statusFilter').value;
    const loadingEl = document.getElementById('loadingMessage');
    const errorEl = document.getElementById('errorMessage');
    const tbody = document.getElementById('bookingsBody');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    tbody.innerHTML = '';

    try {
      let url = `${API_URL}/admin/bookings`;
      if (status) {
        url += `?status=${status}`;
      }

      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();

      if (result.success) {
        displayBookings(result.data);
        updateStats(result.meta);
      } else {
        showError('Failed to load bookings: ' + result.message);
      }
    } catch (error) {
      showError('Error connecting to server: ' + error.message);
    } finally {
      loadingEl.style.display = 'none';
    }
  }

  // Display bookings in table
  function displayBookings(bookings) {
    const tbody = document.getElementById('bookingsBody');
    
    if (bookings.length === 0) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 30px;">No bookings found</td></tr>';
      return;
    }

    tbody.innerHTML = bookings.map(booking => `
      <tr>
        <td>#${booking.id}</td>
        <td>${booking.user.full_name}</td>
        <td>${booking.user.email}</td>
        <td>${booking.schedule.trip_date}</td>
        <td>${booking.schedule.departure_time}</td>
        <td>${booking.schedule.vehicle_number}</td>
        <td>${booking.seat_number}</td>
        <td>${booking.pickup_location || 'N/A'}</td>
        <td><span class="status-badge status-${booking.status}">${booking.status}</span></td>
        <td>
          ${booking.status === 'pending' ? `
            <button class="action-btn approve-btn" onclick="approveBooking(${booking.id})">Approve</button>
            <button class="action-btn reject-btn" onclick="openRejectModal(${booking.id})">Reject</button>
          ` : '-'}
        </td>
      </tr>
    `).join('');
  }

  // Update statistics
  function updateStats(meta) {
    if (meta) {
      document.getElementById('totalBookings').textContent = meta.total || 0;
      document.getElementById('pendingBookings').textContent = meta.pending || 0;
      document.getElementById('approvedBookings').textContent = meta.approved || 0;
      document.getElementById('rejectedBookings').textContent = meta.rejected || 0;
    }
  }

  // Approve booking
  async function approveBooking(bookingId) {
    if (!confirm('Are you sure you want to approve this booking?')) return;

    try {
      const response = await fetch(`${API_URL}/admin/bookings/${bookingId}/approve`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();

      if (result.success) {
        alert('Booking approved successfully! Email sent to student.');
        loadBookings();
      } else {
        alert('Failed to approve booking: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // Open reject modal
  function openRejectModal(bookingId) {
    currentRejectBookingId = bookingId;
    document.getElementById('rejectionReason').value = '';
    document.getElementById('rejectModal').style.display = 'flex';
  }

  // Close reject modal
  function closeRejectModal() {
    currentRejectBookingId = null;
    document.getElementById('rejectModal').style.display = 'none';
  }

  // Confirm rejection
  async function confirmReject() {
    const reason = document.getElementById('rejectionReason').value.trim();

    if (!reason) {
      alert('Please provide a rejection reason');
      return;
    }

    try {
      const response = await fetch(`${API_URL}/admin/bookings/${currentRejectBookingId}/reject`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${getAuthToken()}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          rejection_reason: reason
        })
      });

      const result = await response.json();

      if (result.success) {
        alert('Booking rejected. Email sent to student.');
        closeRejectModal();
        loadBookings();
      } else {
        alert('Failed to reject booking: ' + result.message);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  }

  // Show error message
  function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
  }

  // Logout
  function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    window.location.href = 'login.html';
  }

  // Load bookings on page load
  window.onload = function() {
    if (checkAuth()) {
      loadBookings();
    }
  };
</script>

</body>
</html>